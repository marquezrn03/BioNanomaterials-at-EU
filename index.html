<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>European Landscape: Bio-Based Nanomaterials (More Institutions Added)</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Variables for modern theme */
        :root {
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --bg-color: #f4f7f6;
            --map-bg-color: #e8ecef;
            --border-color: #d1d9e0;
            --text-color: #333d47;
            --title-color: #2c6e49;
            --popup-bg: #ffffff;
            --popup-border: #e1e5ea;
            --popup-title-color: #2c6e49;
            --popup-section-header: #4c956c;
            --link-color: #1b4332;
            --placeholder-color: #6c757d;
            --legend-bg: rgba(255, 255, 255, 0.95);
            --legend-border: #d1d9e0;
            --button-bg: #4c956c;
            --button-hover-bg: #3a7d53;
            --input-border: #ced4da;
            --input-focus-border: #4c956c;

            /* New Modern Color Palette - Hex codes WITHOUT quotes */
            --uni-color-hex: 2196F3;   /* Blue */
            --inst-color-hex: 4CAF50;  /* Green */
            --comp-color-hex: 9C27B0;  /* Purple */
            --pilot-color-hex: FF9800; /* Orange */
            --network-color-hex: E91E63;/* Pink */
            --other-color-hex: 607D8B; /* Blue Grey */
        }
        /* Basic body and layout styles */
        body {
            font-family: var(--font-family); margin: 0; padding: 0; display: flex;
            flex-direction: column; align-items: center; background-color: var(--bg-color);
            color: var(--text-color); line-height: 1.6;
        }
        h1 {
            margin: 30px 10px 15px 10px; color: var(--title-color); text-align: center;
            font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;
            width: 90%; max-width: 1100px; font-size: 1.8em; letter-spacing: -0.2px;
        }
        .disclaimer {
            font-size: 0.75em; color: var(--placeholder-color); width: 90%; max-width: 1100px;
            text-align: center; margin-bottom: 15px; /* Reduced margin */
            border: 1px solid var(--popup-border);
            padding: 10px; background-color: var(--popup-bg); border-radius: 6px;
        }
        /* Search Bar Styles */
        .search-container {
            display: flex;
            gap: 8px; /* Space between input and button */
            margin-bottom: 20px;
            width: 90%;
            max-width: 600px; /* Limit search bar width */
        }
        #search-input {
            flex-grow: 1; /* Input takes available space */
            padding: 10px 14px;
            font-size: 0.95em;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            color: var(--text-color);
            background-color: #fff;
            transition: border-color 0.2s ease;
        }
        #search-input:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 2px rgba(76, 149, 108, 0.2); /* Subtle focus ring */
        }
        #search-button {
            padding: 10px 18px;
            font-size: 0.95em;
            font-weight: 500;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #search-button:hover {
            background-color: var(--button-hover-bg);
        }
        #search-message {
            font-size: 0.85em;
            color: var(--placeholder-color);
            height: 1.2em; /* Reserve space to prevent layout shift */
            margin-top: -10px; /* Adjust spacing */
            margin-bottom: 10px;
            text-align: center;
            width: 90%;
            max-width: 600px;
        }

        /* Map container style */
        #map {
            height: 75vh; /* Slightly reduced height to accommodate search */
            width: 98%; max-width: 1800px; border: 1px solid var(--border-color);
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            margin-bottom: 25px; background-color: var(--map-bg-color);
        }
        /* Legend styles */
        .legend {
            font-size: 0.8em; padding: 12px 18px; background-color: var(--legend-bg);
            border: 1px solid var(--legend-border); border-radius: 8px; margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); backdrop-filter: blur(4px);
        }
        .legend h4 {
            margin: 0 0 10px 0; font-size: 0.85em; color: var(--popup-section-header);
            text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--popup-border);
            padding-bottom: 6px; font-weight: 600;
        }
        .legend div { margin-bottom: 6px; display: flex; align-items: center; }
        .legend div:last-child { margin-bottom: 0; }
        .legend img.legend-icon { /* Style for the icon image */
            width: 18px; height: 18px; margin-right: 8px;
            vertical-align: middle; flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1); border-radius: 2px;
        }
        /* Leaflet control styles */
        .leaflet-control-container .leaflet-control {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .leaflet-control-layers {
            background-color: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
            border-radius: 6px; padding: 10px; max-height: 60vh; /* Adjusted max height */
             overflow-y: auto;
        }
        .leaflet-control-layers-base label,
        .leaflet-control-layers-overlays label {
            color: var(--text-color); font-size: 0.9em; display: flex;
            align-items: center; margin-bottom: 5px; cursor: pointer; font-weight: 500;
        }
         /* Style for icons in layer control */
        img.layer-control-icon {
            width: 16px; height: 16px; margin-right: 8px;
            vertical-align: middle; flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1); border-radius: 2px;
        }
        .leaflet-control-layers-separator {
            border-top: 1px solid var(--popup-border); margin: 8px -10px;
        }
        /* Leaflet popup styles - Modernized */
        .leaflet-popup { transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
        .leaflet-popup-content-wrapper {
            border-radius: 8px; background-color: var(--popup-bg); border: 1px solid var(--popup-border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden;
        }
        .leaflet-popup-content {
            font-size: 0.9em; line-height: 1.6; color: var(--text-color);
            max-height: 350px; /* Adjusted max height */
             overflow-y: auto; padding: 0;
        }
        .leaflet-popup-content b.popup-title {
            font-size: 1.1em; color: var(--popup-title-color); font-weight: 600;
            display: block; margin: 0; padding: 14px 20px;
            border-bottom: 1px solid var(--popup-border); background-color: #f9fafb;
        }
        .popup-section {
            margin: 0; padding: 12px 20px; border-top: 1px solid #f1f3f5;
        }
        .popup-section:first-of-type { border-top: none; }
        .popup-section h4 {
            margin: 0 0 6px 0; font-size: 0.7em; color: var(--popup-section-header);
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.7px;
        }
        .popup-section .content-text { font-size: 0.88em; margin: 0 0 4px 0; display: block; }
        .popup-section .content-text:last-child { margin-bottom: 0; }
        .popup-section .content-text.focus { font-weight: 500; color: var(--title-color); }
        .popup-section .content-text.location { color: #555; }
        .popup-section .content-text.info { color: #444; }
        .popup-section a {
            color: var(--link-color); text-decoration: none; font-size: 0.85em;
            display: inline-block; margin-top: 8px; font-weight: 600;
            padding: 4px 8px; border-radius: 4px; transition: background-color 0.2s ease;
        }
        .popup-section a:hover { text-decoration: none; background-color: #e9f5db; }
        .leaflet-popup-tip-container { width: 20px; height: 10px; }
        .leaflet-popup-tip { box-shadow: none; }

        /* Leaflet tooltip styles - Modernized */
        .leaflet-tooltip {
            border-radius: 5px; background-color: rgba(40, 40, 40, 0.85); color: #fff;
            border: none; box-shadow: 0 1px 5px rgba(0,0,0,0.2); padding: 5px 10px;
            font-size: 0.85em; font-weight: 500; backdrop-filter: blur(2px);
        }

        /* Marker cluster styles - Use modern theme colors */
        .marker-cluster div {
            color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); width: 30px; height: 30px;
            margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 15px;
            font: 12px var(--font-family); font-weight: 600; line-height: 30px;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }
        .marker-cluster-small { background-color: rgba(76, 175, 80, 0.7); } /* Green */
        .marker-cluster-small div { background-color: rgba(76, 175, 80, 0.9); }
        .marker-cluster-medium { background-color: rgba(255, 152, 0, 0.7); } /* Orange */
        .marker-cluster-medium div { background-color: rgba(255, 152, 0, 0.9); }
        .marker-cluster-large { background-color: rgba(33, 150, 243, 0.7); } /* Blue */
        .marker-cluster-large div { background-color: rgba(33, 150, 243, 0.9); }

        /* Custom control styles (Recenter button) */
        .leaflet-control-custom {
            background-color: white; border: 1px solid var(--border-color); border-radius: 6px;
            width: 34px; height: 34px; text-align: center; line-height: 34px; cursor: pointer;
            font-weight: bold; font-size: 1.5em; color: #555;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: background-color 0.2s ease, color 0.2s ease;
        }
        .leaflet-control-custom:hover { background-color: #f1f3f5; color: #111; }

        /* Marker hover effect */
        .marker-hover {
            transform: scale(1.15);
            z-index: 1000 !important;
        }
        /* Apply transition to the marker icon itself */
        .leaflet-marker-icon {
            transition: transform 0.15s ease-out;
        }

    </style>
</head>
<body>
    <h1>European Landscape: Bio-Based Nanomaterials (Lignin, Cellulose, Chitin)</h1>
    <div class="disclaimer">
        Disclaimer: Represents a snapshot. Landscape is dynamic. Developed by ronald.marquez@udg.edu / Powered by Gemini 2.5
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search for institution...">
        <button id="search-button">Search</button>
    </div>
    <div id="search-message"></div> <div id="map"></div>

    <div class="legend">
        <h4>Legend</h4>
        <div><img src="https://placehold.co/32x32/2196F3/FFFFFF?text=UNI&font=lato" alt="University Icon" class="legend-icon"> University</div>
        <div><img src="https://placehold.co/32x32/4CAF50/FFFFFF?text=INST&font=lato" alt="Institute Icon" class="legend-icon"> Research Institute / RTO</div>
        <div><img src="https://placehold.co/32x32/9C27B0/FFFFFF?text=CO&font=lato" alt="Company Icon" class="legend-icon"> Company</div>
        <div><img src="https://placehold.co/32x32/FF9800/FFFFFF?text=PILOT&font=lato" alt="Pilot Plant Icon" class="legend-icon"> Pilot Plant / Facility</div>
        <div><img src="https://placehold.co/32x32/E91E63/FFFFFF?text=NET&font=lato" alt="Network Icon" class="legend-icon"> Network / Association</div>
        <div><img src="https://placehold.co/32x32/607D8B/FFFFFF?text=?&font=lato" alt="Other Icon" class="legend-icon"> Other / Unspecified</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map', {
            center: [50.0, 10.0], // Initial center of Europe
            zoom: 5,             // Initial zoom level
            worldCopyJump: true  // Prevents markers from duplicating when panning across the date line
        });

        // --- Tile Layers ---
        const osmTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors', maxZoom: 18 });
        const stamenTonerLite = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: 'abcd', maxZoom: 20, ext: 'png' });
        const cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd', maxZoom: 20 });
        cartoPositron.addTo(map); // Add default layer

        // --- Custom Icons using placehold.co (Square Style with MODERN Colors) ---
        const iconWidth = 32;
        const iconHeight = 32;
        const iconAnchor = [iconWidth / 2, iconHeight];
        const popupAnchor = [0, -iconHeight + 4];

        // Function to create icons using placehold.co service
        const createIcon = (hexColor, text) => L.icon({
            iconUrl: `https://placehold.co/${iconWidth}x${iconHeight}/${hexColor}/FFFFFF?text=${encodeURIComponent(text)}&font=lato`,
            iconSize: [iconWidth, iconHeight],
            iconAnchor: iconAnchor,
            popupAnchor: popupAnchor,
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            shadowSize: [41, 41],
            shadowAnchor: [iconWidth / 2 - 1, 41]
        });

        // Get MODERN hex codes from CSS variables (trim whitespace)
        const styles = getComputedStyle(document.documentElement);
        const uniHex = styles.getPropertyValue('--uni-color-hex').trim();
        const instHex = styles.getPropertyValue('--inst-color-hex').trim();
        const compHex = styles.getPropertyValue('--comp-color-hex').trim();
        const pilotHex = styles.getPropertyValue('--pilot-color-hex').trim();
        const networkHex = styles.getPropertyValue('--network-color-hex').trim();
        const otherHex = styles.getPropertyValue('--other-color-hex').trim();

        // Define icons for different entity types using the MODERN hex codes
        const icons = {
            university: createIcon(uniHex, 'UNI'),
            institute: createIcon(instHex, 'INST'),
            company: createIcon(compHex, 'CO'),
            pilot_plant: createIcon(pilotHex, 'PILOT'),
            network: createIcon(networkHex, 'NET'),
            other: createIcon(otherHex, '?')
        };


        // --- Comprehensive Data Source (Added new institutions) ---
        const entitiesData = [
             // UK Universities
            { name: "University of Cambridge", type: "University", city: "Cambridge", country: "UK", lat: 52.20, lon: 0.12, focus: ["Materials Science", "Nanotech"], keyInfo: "#1 Materials Science Europe, #1 Nanotech UK.", iconType: 'university' },
            { name: "University of Manchester", type: "University", city: "Manchester", country: "UK", lat: 53.46, lon: -2.23, focus: ["Nanotech", "Advanced Materials"], keyInfo: "#2 Nanotech UK. MSc Advanced Materials.", iconType: 'university' },
            { name: "Imperial College London", type: "University", city: "London", country: "UK", lat: 51.50, lon: -0.17, focus: ["Nanotech"], keyInfo: "#3 Nanotech UK.", iconType: 'university' },
            { name: "University of Oxford", type: "University", city: "Oxford", country: "UK", lat: 51.75, lon: -1.25, focus: ["Nanotech"], keyInfo: "#4 Nanotech UK.", iconType: 'university' },
            { name: "University of Sheffield", type: "University", city: "Sheffield", country: "UK", lat: 53.38, lon: -1.47, focus: ["Nanotech"], keyInfo: "#7 Nanotech UK.", iconType: 'university' },
            { name: "University of Southampton", type: "University", city: "Southampton", country: "UK", lat: 50.93, lon: -1.39, focus: ["Nanotech"], keyInfo: "#8 Nanotech UK.", iconType: 'university' },
            { name: "University of Edinburgh", type: "University", city: "Edinburgh", country: "UK", lat: 55.94, lon: -3.18, focus: ["General Biobased"], keyInfo: "BIOMAC partner (UEDIN PL8).", iconType: 'university' },
            { name: "Manchester Metropolitan University", type: "University", city: "Manchester", country: "UK", lat: 53.47, lon: -2.24, focus: ["Advanced Materials"], keyInfo: "Offers MSc Advanced Materials.", iconType: 'university' },
            { name: "Brunel University", type: "University", city: "London", country: "UK", lat: 51.53, lon: -0.47, focus: ["Biomaterials", "Plastics"], keyInfo: "Partner in RECOVER project.", iconType: 'university' },

            // CH Universities & Institutes
            { name: "ETH Zurich", type: "University", city: "Zurich", country: "CH", lat: 47.37, lon: 8.54, focus: ["Materials Science", "Nanotech", "Cellulose", "Lignin", "Wood Materials"], keyInfo: "#2 Materials Science Europe. Prof. Ingo Burgert (Wood Materials Science).", iconType: 'university' },
            { name: "EPFL Lausanne", type: "University", city: "Lausanne", country: "CH", lat: 46.52, lon: 6.56, focus: ["Nanotech"], keyInfo: "#1 Nanotech CH.", iconType: 'university' },
            { name: "University of Basel", type: "University", city: "Basel", country: "CH", lat: 47.55, lon: 7.59, focus: ["Nanotech"], keyInfo: "#3 Nanotech CH.", iconType: 'university' },
            { name: "Empa", type: "Institute", city: "Dübendorf/St. Gallen", country: "CH", lat: 47.39, lon: 8.61, focus: ["Cellulose", "Lignin", "Wood Materials", "Aerogels", "3D Printing"], keyInfo: "Cellulose & Wood Materials Lab (Dr. Nyström). LCNFs, aerogels, 3D printing.", iconType: 'institute' },
            { name: "Université de Genève", type: "University", city: "Geneva", country: "CH", lat: 46.20, lon: 6.14, focus: ["General Research"], keyInfo: "Invited speaker (Ross Milton) at MRS Symposium on Biohybrid Devices.", iconType: 'university' }, // NEW

            // DE Universities & Institutes
            { name: "Karlsruhe Institute of Technology (KIT)", type: "University", city: "Karlsruhe", country: "DE", lat: 49.01, lon: 8.40, focus: ["Materials Science", "Nanotech", "Cellulose", "Lignin", "Sustainable Polymers", "Catalysis"], keyInfo: "#3 Materials Science Europe. Prof. Behrens (NPs), Prof. Meier (Sustainable Polymers), Prof. Holtmann (Biotech).", iconType: 'university' },
            { name: "RWTH Aachen", type: "University", city: "Aachen", country: "DE", lat: 50.77, lon: 6.08, focus: ["Nanotech", "Biobased Materials"], keyInfo: "#4 Nanotech DE. Part of AMIBM.", iconType: 'university' },
            { name: "University of Munich (LMU/TUM)", type: "University", city: "Munich", country: "DE", lat: 48.14, lon: 11.57, focus: ["Nanotech"], keyInfo: "#6 Nanotech DE. Also includes TU Munich (CHI-BIO partner).", iconType: 'university' },
            { name: "University of Freiburg", type: "University", city: "Freiburg", country: "DE", lat: 47.99, lon: 7.84, focus: ["Nanotech"], keyInfo: "#10 Nanotech DE.", iconType: 'university' },
            { name: "Free University of Berlin", type: "University", city: "Berlin", country: "DE", lat: 52.45, lon: 13.29, focus: ["Nanotech"], keyInfo: "#11 Nanotech DE.", iconType: 'university' },
            { name: "University of Stuttgart", type: "University", city: "Stuttgart", country: "DE", lat: 48.78, lon: 9.18, focus: ["Nanotech"], keyInfo: "#36 Nanotech DE.", iconType: 'university' },
            { name: "Hochschule Muenchen", type: "University", city: "Munich", country: "DE", lat: 48.15, lon: 11.55, focus: ["Micro/Nanotechnology"], keyInfo: "Offers MSc Micro- and Nanotechnology.", iconType: 'university' },
            { name: "PFH Private University", type: "University", city: "Göttingen", country: "DE", lat: 51.54, lon: 9.93, focus: ["Composites"], keyInfo: "MSc Lightweight Engineering & Composites.", iconType: 'university' },
            { name: "University of Bayreuth", type: "University", city: "Bayreuth", country: "DE", lat: 49.93, lon: 11.58, focus: ["Chitin/Chitosan"], keyInfo: "Prof. Anayancy Osorio-Madrazo (EUCHIS Secretary).", iconType: 'university' },
            { name: "Universität Siegen", type: "University", city: "Siegen", country: "DE", lat: 50.88, lon: 8.02, focus: ["Chitin/Chitosan"], keyInfo: "Prof. Hans Merzendorfer (EUCHIS Asst. Secretary).", iconType: 'university' },
            { name: "Universität Münster", type: "University", city: "Münster", country: "DE", lat: 51.96, lon: 7.62, focus: ["Chitin/Chitosan"], keyInfo: "Prof. Bruno Moerschbacher (EUCHIS Asst. Treasurer).", iconType: 'university' },
            { name: "Albstadt-Sigmaringen University", type: "University", city: "Albstadt", country: "DE", lat: 48.21, lon: 9.02, focus: ["Biomaterials", "Plastics"], keyInfo: "Partner in RECOVER project.", iconType: 'university' },
            { name: "Fraunhofer WKI", type: "Institute", city: "Braunschweig", country: "DE", lat: 52.27, lon: 10.52, focus: ["Cellulose", "Composites", "Wood Research"], keyInfo: "Wood Research. BIOMAC (PL12). ValBio-3D.", iconType: 'institute' },
            { name: "Fraunhofer IAP", type: "Institute", city: "Potsdam", country: "DE", lat: 52.39, lon: 13.06, focus: ["Cellulose", "Lignin", "Chitin", "Polysaccharides"], keyInfo: "Polysaccharide Chemistry. MFC/NFC production.", iconType: 'institute' },
            { name: "Fraunhofer IVV", type: "Institute", city: "Freising", country: "DE", lat: 48.40, lon: 11.74, focus: ["Cellulose", "Packaging"], keyInfo: "Process Engineering & Packaging. Nanocellulose barrier coatings (CoatNanoCell).", iconType: 'institute' },
            { name: "Fraunhofer IBMT", type: "Institute", city: "St. Ingbert", country: "DE", lat: 49.28, lon: 7.11, focus: ["Nanotoxicology", "Biomedical"], keyInfo: "Biomedical Engineering. Nanocellulose safety (NanoCELL).", iconType: 'institute' },
            { name: "Leibniz Institute for Agricultural Engineering and Bioeconomy (ATB)", type: "Institute", city: "Potsdam", country: "DE", lat: 52.38, lon: 13.07, focus: ["Biomass Processing"], keyInfo: "BIOMAC partner (PL7).", iconType: 'institute' },
            { name: "Aachen-Maastricht Institute for Biobased Materials (AMIBM)", type: "Institute", city: "Geleen (NL) / Aachen (DE)", country: "DE/NL", lat: 50.97, lon: 5.83, focus: ["Biobased Materials"], keyInfo: "Cross-border institute (Maastricht Uni, RWTH Aachen, Fraunhofer IME).", iconType: 'institute' },
            { name: "FDX Fluid Dynamix GmbH", type: "Company", city: "Berlin", country: "DE", lat: 52.52, lon: 13.40, focus: ["Fluid Dynamics"], keyInfo: "Partner in \"Zielwirk\" project (chitosan for mRNA delivery).", iconType: 'company' }, // NEW
            { name: "Fraunhofer Institute for Production Systems and Design Technology (IPK)", type: "Institute", city: "Berlin", country: "DE", lat: 52.51, lon: 13.32, focus: ["Production Tech"], keyInfo: "Partner in \"Zielwirk\" project (chitosan for mRNA delivery).", iconType: 'institute' }, // NEW
            { name: "Martin Luther University Halle-Wittenberg", type: "University", city: "Halle (Saale)", country: "DE", lat: 51.48, lon: 11.97, focus: ["Chitosan", "mRNA Delivery"], keyInfo: "Partner in \"Zielwirk\" project.", iconType: 'university' }, // NEW
            { name: "University of Potsdam", type: "University", city: "Potsdam", country: "DE", lat: 52.40, lon: 13.06, focus: ["General Research"], keyInfo: "EUCHIS 2023 Scientific Committee member (Martin Peter).", iconType: 'university' }, // NEW

            // SE Universities & Institutes
            { name: "Linkoping University", type: "University", city: "Linköping", country: "SE", lat: 58.39, lon: 15.57, focus: ["Materials Science", "Nanotech"], keyInfo: "#4 Materials Science Europe, #1 Nanotech SE.", iconType: 'university' },
            { name: "KTH Royal Institute of Technology", type: "University", city: "Stockholm", country: "SE", lat: 59.35, lon: 18.07, focus: ["Nanotech"], keyInfo: "#2 Nanotech SE.", iconType: 'university' },
            { name: "Chalmers University of Technology", type: "University", city: "Gothenburg", country: "SE", lat: 57.69, lon: 11.97, focus: ["Nanotech", "Materials Engineering"], keyInfo: "#3 Nanotech SE. MSc Nanotechnology, Materials Engineering.", iconType: 'university' },
            { name: "Lund University", type: "University", city: "Lund", country: "SE", lat: 55.71, lon: 13.20, focus: ["Nanotech"], keyInfo: "#4 Nanotech SE.", iconType: 'university' },
            { name: "Luleå University of Technology (LTU)", type: "University", city: "Luleå", country: "SE", lat: 65.61, lon: 22.14, focus: ["Lignin", "Wood Chemistry", "Biomass Processing"], keyInfo: "BIOMAC partner (PL1). Research on lignin extraction.", iconType: 'university' },
            { name: "Stockholm University - Dept. of Chemistry", type: "University", city: "Stockholm", country: "SE", lat: 59.3668831, lon: 18.0596599, focus: ["Chemistry", "Materials", "Natural Sciences"], keyInfo: "Major Swedish university, specific focus in Chemistry Dept.", iconType: 'university' }, // UPDATED
            { name: "RISE Research Institutes of Sweden", type: "Institute", city: "Stockholm / Örnsköldsvik / etc.", country: "SE", lat: 59.33, lon: 18.06, focus: ["Lignin", "Cellulose (CNF/CNC)"], keyInfo: "LignoBoost/LignoDemo. Nanocellulose pilot plants (MFC/CNC). BIOMAC (PL2).", iconType: 'institute' },
            { name: "RISE Processum", type: "Institute", city: "Örnsköldsvik", country: "SE", lat: 63.29, lon: 18.71, focus: ["Biorefinery"], keyInfo: "Biorefinery R&D. BIOMAC partner.", iconType: 'institute' },
            { name: "LignoCity", type: "Pilot Plant", city: "Bäckhammar", country: "SE", lat: 59.16, lon: 14.13, focus: ["Lignin"], keyInfo: "Open testbed for lignin valorization. Hosts RISE & Lixea pilot.", iconType: 'pilot_plant' },
            { name: "Data-driven Life Science (DDLS)", type: "Network", city: "Stockholm", country: "SE", lat: 59.33, lon: 18.06, focus: ["Life Science", "Data Science"], keyInfo: "Wallenberg-funded program, potential collaboration with WWSC/WISE.", iconType: 'network' }, // NEW
            { name: "Experimentell Cancer Medicin (ECM)", type: "Institute", city: "Huddinge", country: "SE", lat: 59.24, lon: 17.98, focus: ["Cancer Research", "Vaccine Delivery"], keyInfo: "Research on chitosan nanoparticles for vaccine delivery. (Likely Karolinska Inst.)", iconType: 'institute' }, // NEW
            { name: "Mid Sweden University", type: "University", city: "Sundsvall", country: "SE", lat: 62.39, lon: 17.30, focus: ["Forest Products", "Chemistry"], keyInfo: "Hosting EPNOE 2025 conference; FSCN Research Centre.", iconType: 'university' }, // NEW
            { name: "Treesearch", type: "Network", city: "Stockholm", country: "SE", lat: 59.33, lon: 18.06, focus: ["Forest Biomaterials"], keyInfo: "Industry support platform for WWSC.", iconType: 'network' }, // NEW
            { name: "Wallenberg Centre for Quantum Technology (WACQT)", type: "Network", city: "Gothenburg", country: "SE", lat: 57.70, lon: 11.97, focus: ["Quantum Technology"], keyInfo: "Wallenberg-funded program, potential collaboration with WWSC/WISE.", iconType: 'network' }, // NEW (Coord at Chalmers)
            { name: "Wallenberg Initiative Material Science for Sustainability (WISE)", type: "Network", city: "Linköping", country: "SE", lat: 58.39, lon: 15.57, focus: ["Sustainable Materials"], keyInfo: "Wallenberg-funded program, potential collaboration with WWSC.", iconType: 'network' }, // NEW (Coord at Linkoping)

            // NL Universities & Institutes
            { name: "Delft University of Technology (TU Delft)", type: "University", city: "Delft", country: "NL", lat: 52.00, lon: 4.37, focus: ["Nanotech"], keyInfo: "#1 Nanotech NL.", iconType: 'university' },
            { name: "University of Groningen", type: "University", city: "Groningen", country: "NL", lat: 53.22, lon: 6.56, focus: ["Nanoscience"], keyInfo: "#2 Nanotech NL. MSc Nanoscience. Zernike Institute.", iconType: 'university' },
            { name: "University of Utrecht", type: "University", city: "Utrecht", country: "NL", lat: 52.09, lon: 5.12, focus: ["Nanotech"], keyInfo: "#4 Nanotech NL.", iconType: 'university' },
            { name: "Wageningen University & Research (WUR)", type: "University", city: "Wageningen", country: "NL", lat: 51.98, lon: 5.66, focus: ["Lignin", "Cellulose", "Biobased Materials"], keyInfo: "Major player. WFBR (Food & Biobased Research - G. van Erven).", iconType: 'university' },
            { name: "Maastricht University", type: "University", city: "Maastricht", country: "NL", lat: 50.85, lon: 5.69, focus: ["Biobased Materials"], keyInfo: "MSc Biobased Materials. Part of AMIBM.", iconType: 'university' },
            { name: "Leiden University Medical Center", type: "University", city: "Leiden", country: "NL", lat: 52.16, lon: 4.49, focus: ["Medical Research", "Carbohydrates"], keyInfo: "Co-organizer of carbohydrate course.", iconType: 'university' }, // NEW
            { name: "University of Twente", type: "University", city: "Enschede", country: "NL", lat: 52.22, lon: 6.89, focus: ["Sustainable Polymers", "Cellulose", "Lignin", "Starch"], keyInfo: "Sustainable Polymer Chemistry group.", iconType: 'university' }, // NEW

            // FR Universities & Institutes
            { name: "University of Paris-Saclay", type: "University", city: "Paris area", country: "FR", lat: 48.70, lon: 2.17, focus: ["Nanotech"], keyInfo: "#1 Nanotech FR.", iconType: 'university' },
            { name: "Claude Bernard University Lyon 1", type: "University", city: "Lyon", country: "FR", lat: 45.78, lon: 4.87, focus: ["Chitin/Chitosan", "Polymers"], keyInfo: "#2 Nanotech FR. Prof. Laurent David (EUCHIS President).", iconType: 'university' },
            { name: "Grenoble Alpes University", type: "University", city: "Grenoble", country: "FR", lat: 45.19, lon: 5.76, focus: ["Nanotech", "Cellulose", "Packaging"], keyInfo: "#4 Nanotech FR. Close ties to CERMAV/LGP2 (packaging focus).", iconType: 'university' },
            { name: "University of Bordeaux", type: "University", city: "Bordeaux", country: "FR", lat: 44.83, lon: -0.58, focus: ["Nanotech"], keyInfo: "#5 Nanotech FR.", iconType: 'university' },
            { name: "CERMAV (CNRS)", type: "Institute", city: "Grenoble", country: "FR", lat: 45.19, lon: 5.77, focus: ["Cellulose (CNC/CNF)", "Chitin", "Liquid Crystals", "Packaging"], keyInfo: "Plant Macromolecules Research. CNC self-assembly, composites, nanopaper. Key researchers: Bras, Dufresne, Putaux.", iconType: 'institute' },
            { name: "LGP2 (Grenoble INP - UGA)", type: "Institute", city: "Grenoble", country: "FR", lat: 45.19, lon: 5.76, focus: ["Pulp & Paper", "Nanocellulose", "Composites", "Surface Functionalization"], keyInfo: "Laboratory of Pulp and Paper Science and Graphic Arts. Coordinated ERC FUNMAT.", iconType: 'institute' },
            { name: "Campus des Métiers et des Qualifications Forêt-Bois", type: "Network", city: "Toulouse", country: "FR", lat: 43.60, lon: 1.44, focus: ["Forestry", "Wood", "Education"], keyInfo: "Co-organizing conference on Wood and Chemistry.", iconType: 'network' }, // NEW
            { name: "CRT Catar", type: "Institute", city: "Toulouse", country: "FR", lat: 43.60, lon: 1.44, focus: ["Technology Transfer", "Wood"], keyInfo: "Co-organizing conference on Wood and Chemistry.", iconType: 'institute' }, // NEW
            { name: "Institut Universitaire de France (IUF)", type: "Network", city: "Paris", country: "FR", lat: 48.85, lon: 2.35, focus: ["Research Funding"], keyInfo: "Affiliation of researcher involved in lignin nanoparticle templating study.", iconType: 'network' }, // NEW
            { name: "Toulouse INP-ENSIACET", type: "University", city: "Toulouse", country: "FR", lat: 43.56, lon: 1.47, focus: ["Agroindustrial Chemistry", "Wood"], keyInfo: "Hosting conference on Wood and Chemistry; Laboratoire de Chimie Agroindustrielle.", iconType: 'university' }, // NEW

            // IT Universities & Institutes
            { name: "University of Bologna", type: "University", city: "Bologna", country: "IT", lat: 44.49, lon: 11.34, focus: ["Nanotech"], keyInfo: "#1 Nanotech IT.", iconType: 'university' },
            { name: "Sapienza University of Rome", type: "University", city: "Rome", country: "IT", lat: 41.90, lon: 12.51, focus: ["Nanotech"], keyInfo: "#2 Nanotech IT.", iconType: 'university' },
            { name: "Politecnico di Torino", type: "University", city: "Turin", country: "IT", lat: 45.06, lon: 7.66, focus: ["Nanotech"], keyInfo: "MSc Nanotechnologies.", iconType: 'university' },
            { name: "University of Milano - Bicocca", type: "University", city: "Milan", country: "IT", lat: 45.51, lon: 9.21, focus: ["Materials Science", "Nanotech"], keyInfo: "MSc Materials Science/Nanotech.", iconType: 'university' },
            { name: "Ca' Foscari University of Venice", type: "University", city: "Venice", country: "IT", lat: 45.43, lon: 12.32, focus: ["Bio/Nanomaterials"], keyInfo: "MA Bio/Nanomaterials.", iconType: 'university' },
            { name: "University of Pavia", type: "University", city: "Pavia", country: "IT", lat: 45.18, lon: 9.15, focus: ["Chitin/Chitosan", "Biomedical"], keyInfo: "Prof. Carla Marcella Caramella (EUCHIS Board). Pharmaceutical technology.", iconType: 'university' },
            { name: "University of Urbino Carlo Bo", type: "University", city: "Urbino", country: "IT", lat: 43.72, lon: 12.63, focus: ["Chitin/Chitosan", "Biomedical"], keyInfo: "Dr. Luca Casettari (EUCHIS Board). Biomaterials, Drug Delivery.", iconType: 'university' },
            { name: "University of Padua", type: "University", city: "Padua", country: "IT", lat: 45.41, lon: 11.88, focus: ["General Biobased"], keyInfo: "BIOMAC partner.", iconType: 'university' },
            { name: "University of Modena and Reggio Emilia (UNIMORE)", type: "University", city: "Modena", country: "IT", lat: 44.64, lon: 10.92, focus: ["Biowaste", "Chitin"], keyInfo: "Partner in SCALIBUR project.", iconType: 'university' },
            { name: "University of Pisa", type: "University", city: "Pisa", country: "IT", lat: 43.72, lon: 10.40, focus: ["Biotechnology", "Plastic Degradation"], keyInfo: "Partner in RECOVER project.", iconType: 'university' },
            { name: "University of Bari Aldo Moro", type: "University", city: "Bari", country: "IT", lat: 41.11, lon: 16.87, focus: ["General Research", "Chemistry", "Physics", "Biotech"], keyInfo: "Major university in Southern Italy. #13 Nanotech IT (approx.).", iconType: 'university' },
            { name: "JRC Nanobiotechnology Laboratory", type: "Institute", city: "Ispra", country: "IT", lat: 45.81, lon: 8.63, focus: ["Nano/Bio Characterization"], keyInfo: "EU Commission Joint Research Centre. Open access.", iconType: 'institute' },
            { name: "Consiglio Nazionale delle Ricerche (CNR)", type: "Network", city: "Rome", country: "IT", lat: 41.90, lon: 12.49, focus: ["General Research"], keyInfo: "National Research Council. Specific institutes involved (ICCOM Bari, ISB Rome).", iconType: 'network' }, // NEW (Main entry, specific labs noted in info)
            { name: "University of Perugia", type: "University", city: "Perugia", country: "IT", lat: 43.11, lon: 12.38, focus: ["Lignin", "Nanocomposites"], keyInfo: "Research on lignin-based nanocomposites.", iconType: 'university' }, // NEW
            { name: "University of Rome “Tor Vergata”", type: "University", city: "Rome", country: "IT", lat: 41.85, lon: 12.61, focus: ["Antimicrobial Research"], keyInfo: "Collaboration on antimicrobial research involving DFP derivatives.", iconType: 'university' }, // NEW
            { name: "Università degli Studi Mediterranea di Reggio Calabria", type: "University", city: "Reggio Calabria", country: "IT", lat: 38.11, lon: 15.64, focus: ["Catalysis", "Waste Valorization"], keyInfo: "Research on heterogeneous catalysis for waste valorization.", iconType: 'university' }, // NEW

            // ES Universities & Institutes
            { name: "Autonomous University of Madrid (UAM)", type: "University", city: "Madrid", country: "ES", lat: 40.54, lon: -3.69, focus: ["Nanotech"], keyInfo: "#1 Nanotech ES.", iconType: 'university' },
            { name: "Complutense University of Madrid (UCM)", type: "University", city: "Madrid", country: "ES", lat: 40.44, lon: -3.72, focus: ["Chitin/Chitosan"], keyInfo: "#2 Nanotech ES. Prof. Inmaculada Aranaz Corral (EUCHIS VP).", iconType: 'university' },
            { name: "Universitat de Barcelona (UB)", type: "University", city: "Barcelona", country: "ES", lat: 41.38, lon: 2.16, focus: ["Nanoscience/Nanotech"], keyInfo: "MSc Nanoscience/Nanotech.", iconType: 'university' },
            { name: "Universidad de Valladolid", type: "University", city: "Valladolid", country: "ES", lat: 41.65, lon: -4.72, focus: ["Nanoscience/Nanotech"], keyInfo: "MSc Molecular Nanoscience/Nanotech.", iconType: 'university' },
            { name: "University of Girona", type: "University", city: "Girona", country: "ES", lat: 41.98, lon: 2.82, focus: ["Cellulose (Nano)", "Polymers"], keyInfo: "LEPAMAP research group known for nanocellulose.", iconType: 'university' },
            { name: "Miguel Hernandez University", type: "University", city: "Elche", country: "ES", lat: 38.27, lon: -0.69, focus: ["Biotechnology", "Plastic Degradation"], keyInfo: "Partner in RECOVER project.", iconType: 'university' },
            { name: "ICMAB-CSIC", type: "Institute", city: "Barcelona", country: "ES", lat: 41.48, lon: 2.09, focus: ["Materials Science", "Biomimetics"], keyInfo: "Institute of Materials Science of Barcelona.", iconType: 'institute' },
            { name: "ITENE", type: "Institute", city: "Valencia", country: "ES", lat: 39.48, lon: -0.47, focus: ["Cellulose (NFC/CNC)", "Packaging", "Coatings", "Inks"], keyInfo: "Packaging Institute. BIOMAC (PL13 - Nanocellulose Prod., PL14 - Bio-coatings). Biodegradable materials.", iconType: 'institute' },
            { name: "AIMPLAS", type: "Institute", city: "Valencia", country: "ES", lat: 39.48, lon: -0.48, focus: ["Plastics", "Composites", "Biotech", "Chitosan"], keyInfo: "Plastics Technology Institute. BIOMAC (PL11 - Compounding). Extensive pilot plants. Chitosan extraction.", iconType: 'institute' },
            { name: "CINN (CSIC)", type: "Institute", city: "El Entrego, Asturias", country: "ES", lat: 43.29, lon: -5.68, focus: ["Nanomaterials", "Characterization", "Biotesting"], keyInfo: "Nanomaterials & Nanotechnology Research Center.", iconType: 'institute' },
            { name: "AIMEN", type: "Institute", city: "O Porriño, Galicia", country: "ES", lat: 42.16, lon: -8.62, focus: ["Materials Processing"], keyInfo: "Technological Centre. BIOMAC partner (PL15).", iconType: 'institute' },
            { name: "CIB Margarita Salas (CSIC)", type: "Institute", city: "Madrid", country: "ES", lat: 40.44, lon: -3.71, focus: ["Biotechnology", "Lignin", "Enzymes"], keyInfo: "Biological Research Center. Known work on lignin-degrading enzymes.", iconType: 'institute' },
            { name: "BCMaterials", type: "Institute", city: "Leioa", country: "ES", lat: 43.32, lon: -2.99, focus: ["Nanocomposites", "Lignin", "Nanochitin", "LCA"], keyInfo: "Basque Center for Materials. Associated with UPV/EHU.", iconType: 'institute' }, // NEW

            // FI Universities & Institutes
            { name: "Aalto University", type: "University", city: "Espoo", country: "FI", lat: 60.18, lon: 24.83, focus: ["Cellulose", "Lignin", "Chitin", "Mechanochemistry", "Pickering Emulsions"], keyInfo: "Bioproducts Chemistry (Österberg), Synthesis Tech (Kaabel). FinnCERES. BioELCell (Rojas). LNP compatibilizers. Industry collaboration (Kemira).", iconType: 'university' },
            { name: "University of Helsinki", type: "University", city: "Helsinki", country: "FI", lat: 60.17, lon: 24.94, focus: ["Materials Research", "Lignin", "Cellulose"], keyInfo: "MSc Materials Research. LNP/CNF adsorption studies.", iconType: 'university' },
            { name: "University of Turku", type: "University", city: "Turku", country: "FI", lat: 60.45, lon: 22.28, focus: ["Materials Chemistry"], keyInfo: "MSc Materials Chemistry.", iconType: 'university' },
            { name: "VTT Technical Research Centre of Finland", type: "Institute", city: "Espoo / Tampere / etc.", country: "FI", lat: 60.18, lon: 24.82, focus: ["Cellulose", "Lignin", "Biomass Processing", "Coatings"], keyInfo: "Leading RTO. Nanocellulose & Coating pilot plants (SutCo, CelluloseFilms). Coordinated NanoTextSurf. ValBio-3D participant.", iconType: 'institute' },
            { name: "FinnCERES Flagship", type: "Network", city: "Espoo / Helsinki", country: "FI", lat: 60.18, lon: 24.83, focus: ["Lignocellulose"], keyInfo: "Joint competence center (Aalto & VTT).", iconType: 'network' },

            // AT Universities & Institutes
            { name: "BOKU University Vienna", type: "University", city: "Vienna / Tulln", country: "AT", lat: 48.23, lon: 16.33, focus: ["Lignin", "Cellulose", "Wood Chemistry", "Biorefining", "Composites"], keyInfo: "Inst. Chemistry of Renewable Resources (Prof. Rosenau). ALICE Core Facility.", iconType: 'university' },
            { name: "Energieinstitut JKU Linz", type: "Institute", city: "Linz", country: "AT", lat: 48.33, lon: 14.32, focus: ["Energy", "Biorefining"], keyInfo: "Partner in CHI-BIO project.", iconType: 'institute' },
            { name: "Graz University of Technology (TU Graz)", type: "University", city: "Graz", country: "AT", lat: 47.07, lon: 15.43, focus: ["Polysaccharides", "Biobased Systems"], keyInfo: "Host/Organizer EPNOE 2023 conference.", iconType: 'university' }, // NEW
            { name: "University of Graz (UNI Graz)", type: "University", city: "Graz", country: "AT", lat: 47.07, lon: 15.43, focus: ["Polysaccharides"], keyInfo: "Part of Austrian University Consortium organizing EPNOE 2023.", iconType: 'university' }, // NEW
            { name: "University of Innsbruck (UNI Innsbruck)", type: "University", city: "Innsbruck", country: "AT", lat: 47.26, lon: 11.40, focus: ["Polysaccharides"], keyInfo: "Part of Austrian University Consortium organizing EPNOE 2023.", iconType: 'university' }, // NEW
            { name: "University of Vienna (UNI Vienna)", type: "University", city: "Vienna", country: "AT", lat: 48.20, lon: 16.37, focus: ["Polysaccharides"], keyInfo: "Part of Austrian University Consortium organizing EPNOE 2023.", iconType: 'university' }, // NEW

            // IE Universities & Institutes
            { name: "Trinity College Dublin (TCD) - CRANN / AMBER", type: "University", city: "Dublin", country: "IE", lat: 53.34, lon: -6.25, focus: ["Nanoscience", "Materials", "Bioengineering", "Microscopy"], keyInfo: "Leading nanoscience institute. AMBER SFI Centre. Advanced Microscopy Lab. Nanotechnology #1 IE.", iconType: 'university' },
            { name: "Technological University Dublin (TU Dublin) - Nanolab", type: "University", city: "Dublin", country: "IE", lat: 53.35, lon: -6.27, focus: ["Nanomaterial Characterization", "Nano-bio Interactions"], keyInfo: "Specialized characterization facilities.", iconType: 'university' },
            { name: "Atlantic Technological University (ATU) Donegal", type: "University", city: "Letterkenny", country: "IE", lat: 54.95, lon: -7.73, focus: ["Chitin (Implied)"], keyInfo: "Formerly Letterkenny IT. Partner in FP7 CHI-BIO.", iconType: 'university' },
            { name: "Smart Reactors", type: "Company", city: "Dublin", country: "IE", lat: 53.34, lon: -6.26, focus: ["Medtech", "Nanocellulose"], keyInfo: "Leading CellMembrane Horizon Europe project (nanocellulose artificial lung). (Location approx.)", iconType: 'company' }, // NEW

             // BE Universities & Institutes
            { name: "KU Leuven", type: "University", city: "Leuven", country: "BE", lat: 50.88, lon: 4.70, focus: ["Polymers", "Materials Science", "Cellulose"], keyInfo: "Strong materials/polymer science groups, cellulose research.", iconType: 'university' },
            { name: "Ghent University", type: "University", city: "Ghent", country: "BE", lat: 51.05, lon: 3.72, focus: ["Polymers", "Biotechnology", "Materials"], keyInfo: "Notable polymer/materials groups. Close ties to BBEPP.", iconType: 'university' },
            { name: "Bio Base Europe Pilot Plant (BBEPP)", type: "Pilot Plant", city: "Ghent", country: "BE", lat: 51.09, lon: 3.78, focus: ["Biomass Processing", "Fractionation", "Fermentation"], keyInfo: "Independent pilot facility. BIOMAC (PL5/6 - Pre-treatment).", iconType: 'pilot_plant' },

            // PT Universities & Institutes
            { name: "University of Aveiro (UAveiro) - CICECO", type: "University", city: "Aveiro", country: "PT", lat: 40.64, lon: -8.65, focus: ["Materials Science", "Cellulose", "Biopolymers", "Marine Sources"], keyInfo: "CICECO - Aveiro Institute of Materials. Biomimetic/Biological Materials group. Healthcare applications.", iconType: 'university' },
            { name: "University of Minho (UMinho) - I3Bs", type: "University", city: "Guimarães/Braga", country: "PT", lat: 41.55, lon: -8.42, focus: ["Biomaterials", "Tissue Engineering", "Polysaccharides"], keyInfo: "I3Bs Research Institute (Biomaterials, Biodegradables, Biomimetics). Focus on healthcare applications. Nanotechnology #1 PT.", iconType: 'university' },
            { name: "NOVA School of Science and Technology", type: "University", city: "Lisbon area (Caparica)", country: "PT", lat: 38.66, lon: -9.20, focus: ["Materials Science", "Biomaterials", "Nanotech"], keyInfo: "Materials research center (CENIMAT/I3N).", iconType: 'university' },
            { name: "Instituto de Soldadura e Qualidade (ISQ)", type: "Institute", city: "Lisbon (Oeiras)", country: "PT", lat: 38.70, lon: -9.30, focus: ["Testing", "QA", "Process Dev."], keyInfo: "Partner in BIOMAC. Technical testing & quality assurance.", iconType: 'institute' },
            { name: "ANI - Agência Nacional de Inovação, SA", type: "Institute", city: "Lisbon / Porto", country: "PT", lat: 38.72, lon: -9.14, focus: ["Innovation Funding"], keyInfo: "National innovation agency. Eurostars/Innowwide coordination.", iconType: 'institute' },
            { name: "University of Coimbra", type: "University", city: "Coimbra", country: "PT", lat: 40.21, lon: -8.41, focus: ["Chitosan", "Nanoparticles", "Immunotoxicity"], keyInfo: "Research on immunotoxicity of chitosan nanoparticles.", iconType: 'university' }, // NEW

            // CZ Universities & Institutes
            { name: "Technical University of Liberec", type: "University", city: "Liberec", country: "CZ", lat: 50.77, lon: 15.05, focus: ["Nanofibers", "Textiles", "Materials"], keyInfo: "Faculty of Textile Engineering. Known for nanofiber research.", iconType: 'university' },
            { name: "VSB Ostrava", type: "University", city: "Ostrava", country: "CZ", lat: 49.83, lon: 18.16, focus: ["Materials Engineering", "Nanotech"], keyInfo: "Technical University of Ostrava. Materials engineering focus.", iconType: 'university' },
            { name: "Institute of Macromolecular Chemistry, CAS", type: "Institute", city: "Prague", country: "CZ", lat: 50.09, lon: 14.47, focus: ["Chitin (Implied)", "Polymers"], keyInfo: "Partner in FP7 N-CHITOPACK.", iconType: 'institute' },

            // EE Universities
            { name: "University of Tartu", type: "University", city: "Tartu", country: "EE", lat: 58.37, lon: 26.72, focus: ["Materials Science", "Nanomaterials"], keyInfo: "Institute of Chemistry, MSc Materials Sci & Tech, Centres of Excellence.", iconType: 'university' },
            { name: "Tallinn University of Technology (TalTech)", type: "University", city: "Tallinn", country: "EE", lat: 59.39, lon: 24.67, focus: ["Wood", "Plastics", "Textiles"], keyInfo: "MSc Technology of Wood, Plastics and Textiles.", iconType: 'university' },

             // LT Universities & Institutes
            { name: "Lithuanian Research Centre for Agriculture and Forestry (LAMMC)", type: "Institute", city: "Akademija", country: "LT", lat: 54.88, lon: 23.85, focus: ["Biomass", "Forestry", "Agri-materials"], keyInfo: "Integrated research center. Institute of Forestry is key entity.", iconType: 'institute' },
            { name: "Kaunas University of Technology", type: "University", city: "Kaunas", country: "LT", lat: 54.90, lon: 23.95, focus: ["Polymers", "Materials", "Chemical Tech"], keyInfo: "Faculty of Chemical Technology. Polymer/Materials research.", iconType: 'university' },

            // LV Institutes
            { name: "Latvian State Institute of Wood Chemistry (LSIWC)", type: "Institute", city: "Riga", country: "LV", lat: 56.95, lon: 24.10, focus: ["Lignin (Implied)", "Wood Chemistry"], keyInfo: "National R&D institute in wood chemistry.", iconType: 'institute' },

            // SK Institutes
            { name: "VUPC (Pulp and Paper Research Institute)", type: "Institute", city: "Bratislava", country: "SK", lat: 48.17, lon: 17.07, focus: ["Pulp", "Paper", "Cellulose", "Lignin (Implied)"], keyInfo: "Pulp/paper R&D. LignoSilva Centre.", iconType: 'institute' },

            // SI Universities & Institutes
            { name: "InnoRenew CoE", type: "Institute", city: "Izola", country: "SI", lat: 45.54, lon: 13.66, focus: ["Lignin (Nanoparticles)", "Composites", "Renewable Materials"], keyInfo: "Centre of Excellence. Coordinator PACK-NIN project.", iconType: 'institute' },
            { name: "Pulp and Paper Institute", type: "Institute", city: "Ljubljana", country: "SI", lat: 46.05, lon: 14.50, focus: ["Pulp", "Paper", "Packaging"], keyInfo: "Active research institute, conference host.", iconType: 'institute' },
            { name: "University of Maribor", type: "University", city: "Maribor", country: "SI", lat: 46.55, lon: 15.64, focus: ["Polymers", "Materials Engineering"], keyInfo: "Faculty of Chemistry and Chemical Engineering, Faculty of Mechanical Engineering.", iconType: 'university' },

            // IS Universities
            { name: "University of Iceland", type: "University", city: "Reykjavik", country: "IS", lat: 64.14, lon: -21.93, focus: ["Chitin/Chitosan", "Pharmaceutical Sci"], keyInfo: "Prof. Már Másson (EUCHIS VP). Pharmaceutical Sciences.", iconType: 'university' },

            // NO Universities & Institutes
            { name: "RISE PFI AS", type: "Institute", city: "Trondheim", country: "NO", lat: 63.43, lon: 10.39, focus: ["Cellulose (MFC/CNF)", "Functionalization"], keyInfo: "Formerly PFI. FORISS project, ValBio-3D partner. MFC/CNF R&D.", iconType: 'institute' },
            { name: "Nofima AS", type: "Institute", city: "Tromsø", country: "NO", lat: 69.65, lon: 18.95, focus: ["Chitin (implied)", "Food Research", "Packaging"], keyInfo: "Food research institute. Partner in FP7 N-CHITOPACK.", iconType: 'institute' },
            { name: "Norwegian University of Life Sciences (NMBU)", type: "University", city: "Ås", country: "NO", lat: 59.66, lon: 10.78, focus: ["Chitin (implied)", "Biorefining", "Biotechnology"], keyInfo: "Partner in FP7 CHI-BIO project.", iconType: 'university' },

            // LU Institutes
            { name: "LIST (Luxembourg Institute of Science & Technology)", type: "Institute", city: "Esch-sur-Alzette/Belvaux", country: "LU", lat: 49.50, lon: 5.94, focus: ["Lignin", "Cellulose (CNC/MFC)", "Composites", "Smart Textiles", "CO2 Adsorption"], keyInfo: "Materials Research Dept. BIOMAC (PL9, PL10). Lignin vitrimers, NP reinforcement.", iconType: 'institute' },

            // GR Universities & Institutes
            { name: "AUTH", type: "University", city: "Thessaloniki", country: "GR", lat: 40.63, lon: 22.95, focus: ["Nanomaterials", "Thin Films"], keyInfo: "Aristotle University. BIOMAC Partner (PL3) & Coordinator.", iconType: 'university' },

            // DK Institutes
            { name: "Danish Technological Institute (DTI)", type: "Institute", city: "Taastrup", country: "DK", lat: 55.65, lon: 12.29, focus: ["Technology", "Materials"], keyInfo: "BIOMAC partner (PL16). Broad technology expertise.", iconType: 'institute' },

            // TR Universities
            { name: "Amasya University Research Laboratory Center", type: "University", city: "Amasya", country: "TR", lat: 40.65, lon: 35.83, focus: ["Chitosan", "Nanoparticles", "Vaccine Delivery"], keyInfo: "Research on chitosan nanoparticles for vaccine delivery.", iconType: 'university' }, // NEW
            { name: "Ondokuz Mayis University Medical School", type: "University", city: "Samsun", country: "TR", lat: 41.28, lon: 36.33, focus: ["Chitosan", "Nanoparticles", "Vaccine Delivery"], keyInfo: "Research on chitosan nanoparticles for vaccine delivery.", iconType: 'university' }, // NEW

            // Pan-European Institutes/Networks
            { name: "JRC Nanobiotechnology Laboratory", type: "Institute", city: "Ispra", country: "IT", lat: 45.81, lon: 8.63, focus: ["Nano/Bio Characterization"], keyInfo: "EU Commission Joint Research Centre. Open access.", iconType: 'institute' },
            { name: "E-MRS", type: "Network", city: "Strasbourg (HQ)", country: "FR", lat: 48.58, lon: 7.75, focus: ["Materials Science"], keyInfo: "European Materials Research Society.", iconType: 'network' },
            { name: "CERIC-ERIC", type: "Network", city: "Trieste (HQ)", country: "IT", lat: 45.67, lon: 13.78, focus: ["Research Infrastructure"], keyInfo: "Central European Research Infrastructure Consortium.", iconType: 'network' },
            { name: "NFFA-Europe", type: "Network", city: "Trieste (Coord.)", country: "IT", lat: 45.67, lon: 13.78, focus: ["Nanoscale Research"], keyInfo: "Platform for free access to nano research tools.", iconType: 'network' },
            { name: "EUTINN", type: "Network", city: "Brussels (Coord.?)", country: "EU", lat: 50.85, lon: 4.35, focus: ["Nanomaterials", "Nanotech"], keyInfo: "European University of Technology Institute of Nanomaterials & Nanotechnologies.", iconType: 'network' },

            // Companies (Sorted Alphabetically by Name for easier review)
            { name: "ABIS Spolka z Ograniczona Odpowiedzialnoscia SPK", type: "Company", city: "Gliwice", country: "PL", lat: 50.29, lon: 18.67, focus: ["Automation", "Control Systems"], keyInfo: "SME Partner in BIOMAC (PL16).", iconType: 'company' },
            { name: "Acciona Construcción SA", type: "Company", city: "Madrid", country: "ES", lat: 40.41, lon: -3.70, focus: ["Construction"], keyInfo: "BIOMAC Industrial Validator.", iconType: 'company' },
            { name: "Adsorbi", type: "Company", city: "Gothenburg", country: "SE", lat: 57.70, lon: 11.97, focus: ["Cellulose (Aerogel)"], keyInfo: "Startup from Chalmers. Cellulose aerogel foam for air pollution capture (packaging etc.).", iconType: 'company' },
            { name: "Agrana", type: "Company", city: "Vienna", country: "AT", lat: 48.21, lon: 16.37, focus: ["Starch", "Bioplastics"], keyInfo: "EUBP member. Starch-based bioplastics.", iconType: 'company' },
            { name: "Apronex S.R.O.", type: "Company", city: "Vestec", country: "CZ", lat: 49.98, lon: 14.50, focus: ["Chitin (Implied)"], keyInfo: "SME Partner in FP7 CHI-BIO.", iconType: 'company' },
            { name: "Aroma System", type: "Company", city: "Rome (approx.)", country: "IT", lat: 41.90, lon: 12.50, focus: ["Packaging", "Flavors?"], keyInfo: "SME Partner in N-CHITOPACK. Location approximate.", iconType: 'company' },
            { name: "ASAJA", type: "Company", city: "Madrid (approx.)", country: "ES", lat: 40.41, lon: -3.70, focus: ["Agriculture"], keyInfo: "Partner in RECOVER project. National agricultural association.", iconType: 'company' }, // Type is Association, but map uses Company icon
            { name: "Avantium", type: "Company", city: "Amsterdam", country: "NL", lat: 52.37, lon: 4.89, focus: ["Biobased Chemicals", "FDCA", "PEF"], keyInfo: "Developing FDCA from sugars. Dawn Process™.", iconType: 'company' },
            { name: "AXIA Innovation", type: "Company", city: "Copenhagen?", country: "DK", lat: 55.67, lon: 12.56, focus: ["Innovation Management"], keyInfo: "BIOMAC partner. Focus on market uptake.", iconType: 'company' },
            { name: "B4Plastics", type: "Company", city: "Dilsen-Stokkem", country: "BE", lat: 51.03, lon: 5.72, focus: ["Biodegradable Polymers"], keyInfo: "SME developing novel polymers (TriggerPlastics). EIC funded (B4PNOW).", iconType: 'company' },
            { name: "BASF SE", type: "Company", city: "Ludwigshafen", country: "DE", lat: 49.48, lon: 8.43, focus: ["Chemicals"], keyInfo: "Global chemical company. Pulp & Paper chemicals.", iconType: 'company' },
            { name: "BEECO", type: "Company", city: "Brussels?", country: "BE", lat: 50.85, lon: 4.35, focus: ["Biomass/Energy Consulting?"], keyInfo: "SME BIOMAC Partner.", iconType: 'company' },
            { name: "Biozoon", type: "Company", city: "Bremerhaven", country: "DE", lat: 53.54, lon: 8.58, focus: ["Food Technology"], keyInfo: "SME Partner in N-CHITOPACK.", iconType: 'company' },
            { name: "Borregaard ASA", type: "Company", city: "Sarpsborg", country: "NO", lat: 59.28, lon: 11.11, focus: ["Lignin", "Cellulose (MFC)"], keyInfo: "Advanced biorefinery. Leading producer of Lignosulfonates & MFC (Exilva®).", iconType: 'company' },
            { name: "Celignis Ltd.", type: "Company", city: "Limerick", country: "IE", lat: 52.66, lon: -8.62, focus: ["Chitin", "Xylan", "Lignocellulose", "Biomass Analysis", "Biorefining"], keyInfo: "SME. Biomass analysis & R&D services. PERFECOAT, BIONEER projects.", iconType: 'company' },
            { name: "Cellink", type: "Company", city: "Gothenburg", country: "SE", lat: 57.70, lon: 11.98, focus: ["Bioprinting"], keyInfo: "3D Bioprinting technology.", iconType: 'company' },
            { name: "CelluComp", type: "Company", city: "Glenrothes", country: "UK", lat: 56.19, lon: -3.17, focus: ["Cellulose (CNC)"], keyInfo: "Producer of Curran® CNC from root vegetables.", iconType: 'company' },
            { name: "Cellugy ApS", type: "Company", city: "Søborg", country: "DK", lat: 55.73, lon: 12.49, focus: ["Cellulose (BNC)"], keyInfo: "Startup producing bacterial nanocellulose (EcoFLEXY™) for cosmetics. Seed funded.", iconType: 'company' },
            { name: "Clariant", type: "Company", city: "Muttenz", country: "CH", lat: 47.53, lon: 7.64, focus: ["Chemicals"], keyInfo: "Specialty chemicals. Partner in CHI-BIO.", iconType: 'company' },
            { name: "Comp0live Spin-off", type: "Company", city: "Andalusia (likely)", country: "ES", lat: 37.5, lon: -4.5, focus: ["Cellulose (Nano/Acetate)"], keyInfo: "Planned startup from LIFE project using olive waste for biocomposites/packaging. LIFE C2M support.", iconType: 'company' },
            { name: "Creative Nano (Cnano)", type: "Company", city: "Athens", country: "GR", lat: 37.98, lon: 23.72, focus: ["Nanolignin", "Nanoparticles"], keyInfo: "SME. BIOMAC partner (PL4). Nanolignin standardization.", iconType: 'company' },
            { name: "Diad Group SPRL", type: "Company", city: "Rome (approx.)", country: "IT", lat: 42.83, lon: 12.83, focus: ["Unknown"], keyInfo: "BIOMAC Partner. Location uncertain.", iconType: 'company' },
            { name: "Earagail Eisc Teoranta", type: "Company", city: "Carrick", country: "IE", lat: 54.65, lon: -8.63, focus: ["Chitin Source/Processing?"], keyInfo: "SME partner in FP7 CHI-BIO.", iconType: 'company' },
            { name: "Evonik", type: "Company", city: "Essen", country: "DE", lat: 51.45, lon: 7.01, focus: ["Chemicals"], keyInfo: "Specialty chemicals. Partner in CHI-BIO.", iconType: 'company' },
            { name: "Eversia Innova", type: "Company", city: "Madrid (approx.)", country: "ES", lat: 40.41, lon: -3.70, focus: ["Packaging?"], keyInfo: "BIOMAC Industrial Validator. Location uncertain.", iconType: 'company' },
            { name: "Exelisis IKE", type: "Company", city: "Athens (approx.)", country: "GR", lat: 39.0, lon: 22.0, focus: ["R&D/Consulting?"], keyInfo: "BIOMAC Industrial Validator. Location uncertain.", iconType: 'company' },
            { name: "France Chitin", type: "Company", city: "Orange", country: "FR", lat: 44.14, lon: 4.81, focus: ["Chitin/Chitosan"], keyInfo: "Chitin/Chitosan producer.", iconType: 'company' },
            { name: "Heppe Medical Chitosan GmbH", type: "Company", city: "Halle (Saale)", country: "DE", lat: 51.48, lon: 11.97, focus: ["Chitin/Chitosan"], keyInfo: "Medical-grade chitosan producer. EUCHIS Treasurer (Dr. Richter).", iconType: 'company' },
            { name: "Holmen AB", type: "Company", city: "Stockholm", country: "SE", lat: 59.33, lon: 18.07, focus: ["Forest Products", "Cellulose"], keyInfo: "Partner in nanocellulose pilot plant.", iconType: 'company' },
            { name: "Idener Research & Development AIE", type: "Company", city: "Seville?", country: "ES", lat: 37.38, lon: -5.98, focus: ["R&D Services"], keyInfo: "SME BIOMAC Partner.", iconType: 'company' },
            { name: "IRIS Technology Solutions, SL", type: "Company", city: "Barcelona?", country: "ES", lat: 41.38, lon: 2.17, focus: ["Process Monitoring"], keyInfo: "SME BIOMAC Partner.", iconType: 'company' },
            { name: "IsoTimber / Moelven", type: "Company", city: "Various", country: "SE/NO", lat: 60.0, lon: 15.0, focus: ["Construction", "Lignin (user)"], keyInfo: "Using NeoLigno® binder.", iconType: 'company' },
            { name: "Kemira", type: "Company", city: "Helsinki (HQ)", country: "FI", lat: 60.17, lon: 24.94, focus: ["Chemicals", "Biobased Polymers"], keyInfo: "Pulp & Paper chemicals. Polysaccharide polymers. Biomass-balanced PAM.", iconType: 'company' },
            { name: "Kemira Production", type: "Pilot Plant", city: "San Giorgio di Nogaro", country: "IT", lat: 45.80, lon: 13.22, focus: ["Chemicals"], keyInfo: "Biomass-balanced polyacrylamide production.", iconType: 'pilot_plant' }, // Reclassified as Pilot Plant
            { name: "KOUR", type: "Company", city: "Rome (approx.)", country: "IT", lat: 41.90, lon: 12.50, focus: ["Biowaste"], keyInfo: "Partner in SCALIBUR project. Location approximate.", iconType: 'company' },
            { name: "Latvijas Finieris", type: "Company", city: "Riga", country: "LV", lat: 56.95, lon: 24.10, focus: ["Wood Products", "Plywood"], keyInfo: "Collaborated with Stora Enso on Lineo™ lignin adhesive.", iconType: 'company' },
            { name: "Lenzing AG", type: "Company", city: "Lenzing", country: "AT", lat: 47.97, lon: 13.60, focus: ["Cellulose Fibers"], keyInfo: "Major producer of Lyocell (TENCEL™), Modal fibers.", iconType: 'company' },
            { name: "LignoPure GmbH", type: "Company", city: "Hamburg", country: "DE", lat: 53.55, lon: 9.99, focus: ["Lignin (Nanoparticles/Powders)"], keyInfo: "Startup producing LignoBase™ lignin ingredients for cosmetics. €2.4M funding.", iconType: 'company' },
            { name: "Lignovations GmbH", type: "Company", city: "Klosterneuburg", country: "AT", lat: 48.30, lon: 16.32, focus: ["Lignin (Colloidal Particles)"], keyInfo: "Startup producing LignoGuard® colloidal lignin for cosmetics, etc. Member EUBP, Lignin Club.", iconType: 'company' },
            { name: "Lixea", type: "Company", city: "London", country: "UK", lat: 51.50, lon: -0.12, focus: ["Biomass Fractionation", "Ionic Liquids", "Lignin", "Cellulose"], keyInfo: "Developing novel fractionation process. Pilot plant at LignoCity (SE).", iconType: 'company' },
            { name: "MakeGrowLab", type: "Company", city: "Puławy", country: "PL", lat: 51.41, lon: 21.97, focus: ["Cellulose (Bacterial Nanocellulose)", "Packaging"], keyInfo: "Startup converting food waste to Scoby Packaging Material (SPM). EIT Food participant.", iconType: 'company' },
            { name: "MAVI Sud Srl", type: "Company", city: "Aprilia", country: "IT", lat: 41.59, lon: 12.65, focus: ["Chitin (Nanofibrils)"], keyInfo: "SME with patented CN process. Coordinated N-CHITOPACK. Focus on packaging & biomedical.", iconType: 'company' },
            { name: "Melodea Ltd.", type: "Company", city: "Rehovot (HQ)", country: "IL", lat: 31.89, lon: 34.81, focus: ["Cellulose (CNC)", "Packaging Coatings"], keyInfo: "Active in CNC market. Partnering on CNC pilot plant in Sweden. Commercial products.", iconType: 'company' },
            { name: "Microtec", type: "Company", city: "Rome (approx.)", country: "IT", lat: 41.90, lon: 12.50, focus: ["Technology?"], keyInfo: "SME Partner in N-CHITOPACK. Location approximate.", iconType: 'company' },
            { name: "Modern Synthesis", type: "Company", city: "London", country: "UK", lat: 51.52, lon: -0.08, focus: ["Cellulose (BNC - Microbial Weaving)"], keyInfo: "Startup creating nanocellulose textiles. $5.5M funding. GANNI collab.", iconType: 'company' },
            { name: "Mondi", type: "Company", city: "Vienna (Group office)", country: "AT", lat: 48.21, lon: 16.37, focus: ["Packaging", "Paper"], keyInfo: "Sustainable paper/packaging solutions.", iconType: 'company' },
            { name: "MoRe Research", type: "Company", city: "Örnsköldsvik", country: "SE", lat: 63.29, lon: 18.72, focus: ["Cellulose (CNC)", "Forest Products"], keyInfo: "R&D company. Partner in new CNC pilot plant.", iconType: 'company' },
            { name: "Nanotypos (NNT)", type: "Company", city: "Thessaloniki", country: "GR", lat: 40.64, lon: 22.94, focus: ["Nanomanufacturing", "Printed Electronics"], keyInfo: "SME. BIOMAC partner (PL17).", iconType: 'company' },
            { name: "Naturplas", type: "Company", city: "Madrid (approx.)", country: "ES", lat: 40.41, lon: -3.70, focus: ["Plastics"], keyInfo: "Partner in RECOVER project. Location approximate.", iconType: 'company' },
            { name: "Northvolt", type: "Company", city: "Stockholm (HQ) / Skellefteå (Plant)", country: "SE", lat: 64.75, lon: 20.95, focus: ["Batteries", "Lignin (user)"], keyInfo: "Battery manufacturer. Partnering with Stora Enso on Lignode®.", iconType: 'company' },
            { name: "Nouryon", type: "Company", city: "Amsterdam", country: "NL", lat: 52.37, lon: 4.89, focus: ["Chemicals"], keyInfo: "Specialty chemicals (ex-AkzoNobel). Cellulose derivatives.", iconType: 'company' },
            { name: "NovaMatrix (FMC Corp)", type: "Company", city: "Sandvika", country: "NO", lat: 59.89, lon: 10.53, focus: ["Chitin/Chitosan"], keyInfo: "Producer of ultrapure biopolymers for biomedical applications.", iconType: 'company' },
            { name: "Novamont SPA", type: "Company", city: "Novara", country: "IT", lat: 45.44, lon: 8.62, focus: ["Bioplastics"], keyInfo: "Leading bioplastics company. BIOMAC validator.", iconType: 'company' },
            { name: "Ohmatex A/S", type: "Company", city: "Skovlunde", country: "DK", lat: 55.72, lon: 12.41, focus: ["Smart Textiles"], keyInfo: "BIOMAC Industrial Validator.", iconType: 'company' },
            { name: "Postnova Analytics", type: "Company", city: "Landsberg am Lech", country: "DE", lat: 48.05, lon: 10.87, focus: ["Analytical Instruments"], keyInfo: "Coordinator of NanoCELL project.", iconType: 'company' },
            { name: "Primex", type: "Company", city: "Siglufjörður", country: "IS", lat: 66.15, lon: -18.90, focus: ["Chitin/Chitosan"], keyInfo: "Chitin/Chitosan producer.", iconType: 'company' },
            { name: "Rodax Impex", type: "Company", city: "Bucharest (approx.)", country: "RO", lat: 44.43, lon: 26.10, focus: ["Unknown"], keyInfo: "SME Partner in N-CHITOPACK. Location approximate.", iconType: 'company' },
            { name: "Sappi", type: "Company", city: "Brussels (EU HQ)", country: "BE", lat: 50.85, lon: 4.35, focus: ["Lignin", "Cellulose (MFC - Valida™)"], keyInfo: "Global pulp/paper co. Commercial Lignin & MFC producer.", iconType: 'company' },
            { name: "Smurfit Kappa", type: "Company", city: "Dublin (HQ)", country: "IE", lat: 53.34, lon: -6.26, focus: ["Packaging", "Paper"], keyInfo: "Global paper-based packaging leader.", iconType: 'company' },
            { name: "Solvay", type: "Company", city: "Brussels", country: "BE", lat: 50.85, lon: 4.35, focus: ["Chemicals"], keyInfo: "Multinational chemical company.", iconType: 'company' },
            { name: "STAM Srl", type: "Company", city: "Genoa?", country: "IT", lat: 44.40, lon: 8.93, focus: ["Engineering"], keyInfo: "SME BIOMAC Partner.", iconType: 'company' },
            { name: "Stora Enso", type: "Company", city: "Helsinki (HQ)", country: "FI", lat: 60.17, lon: 24.95, focus: ["Lignin", "Cellulose", "Biomaterials"], keyInfo: "Lineo™, NeoLigno®, Lignode®. Sunila Lignode Pilot.", iconType: 'company' },
            { name: "UPM", type: "Company", city: "Helsinki (HQ)", country: "FI", lat: 60.17, lon: 24.94, focus: ["Cellulose (Nano)", "Biochemicals", "Biomedical"], keyInfo: "UPM Biomedicals (GrowDex®, FibDex®, FibGel™).", iconType: 'company' },

            // Networks (Sorted Alphabetically)
            { name: "ACPP (Assoc. Czech Pulp & Paper Ind.)", type: "Network", city: "Prague?", country: "CZ", lat: 50.08, lon: 14.42, focus: ["Industry Association"], keyInfo: "National CEPI member.", iconType: 'network' },
            { name: "BIOMAC OITB", type: "Network", city: "Europe-wide (Coord. GR)", country: "EU", lat: 50.85, lon: 4.35, focus: ["Lignin", "Cellulose", "Pilot Lines"], keyInfo: "Open Innovation Test Bed for Nano-Bio Materials. 17 Pilot Lines. Coordinated by AUTH.", iconType: 'network' },
            { name: "Biond", type: "Network", city: "Lisbon?", country: "PT", lat: 38.72, lon: -9.14, focus: ["Industry Association"], keyInfo: "Portuguese Association of Pulp, Paper and Cardboard Industries. CEPI member.", iconType: 'network' },
            { name: "CCIS (Chamber of Commerce - Paper Assoc.)", type: "Network", city: "Ljubljana", country: "SI", lat: 46.05, lon: 14.50, focus: ["Industry Association"], keyInfo: "Represents paper industry. CEPI member.", iconType: 'network' },
            { name: "CEPI (Confederation of European Paper Industries)", type: "Network", city: "Brussels", country: "BE", lat: 50.84, lon: 4.37, focus: ["Pulp", "Paper", "Bioeconomy"], keyInfo: "Umbrella org for national paper associations.", iconType: 'network' },
            { name: "Die Papierindustrie", type: "Network", city: "Berlin/Bonn?", country: "DE", lat: 52.52, lon: 13.40, focus: ["Industry Association"], keyInfo: "German national paper industry assoc. CEPI member.", iconType: 'network' },
            { name: "EUBIA (European Biomass Industry Association)", type: "Network", city: "Brussels", country: "BE", lat: 50.85, lon: 4.35, focus: ["Biomass", "Bioenergy"], keyInfo: "BIOMAC Partner.", iconType: 'network' },
            { name: "EUCHIS", type: "Network", city: "Europe-wide (Pres. FR)", country: "EU", lat: 45.78, lon: 4.87, focus: ["Chitin/Chitosan"], keyInfo: "European Chitin Society. Key academic & industry members.", iconType: 'network' },
            { name: "European Bioplastics (EUBP)", type: "Network", city: "Berlin", country: "DE", lat: 52.52, lon: 13.40, focus: ["Bioplastics"], keyInfo: "Industry association. BIOMAC partner. Members include LignoPure, Lignovations, Stora Enso.", iconType: 'network' },
            { name: "FFIF (Finnish Forest Industries Federation)", type: "Network", city: "Helsinki", country: "FI", lat: 60.17, lon: 24.94, focus: ["Industry Association"], keyInfo: "National CEPI member.", iconType: 'network' },
            { name: "INSTM", type: "Network", city: "Florence (Consortium HQ)", country: "IT", lat: 43.77, lon: 11.25, focus: ["Materials Science"], keyInfo: "University consortium, partner in N-CHITOPACK and CHI-BIO.", iconType: 'network' },
            { name: "Lignin Club", type: "Network", city: "Finland?", country: "FI", lat: 60.17, lon: 24.94, focus: ["Lignin"], keyInfo: "Industry network fostering lignin ecosystem. Members include LignoPure, Lignovations.", iconType: 'network' },
            { name: "Norsk Industri", type: "Network", city: "Oslo", country: "NO", lat: 59.91, lon: 10.75, focus: ["Industry Association", "Pulp & Paper"], keyInfo: "National industry association. CEPI member.", iconType: 'network' },
            { name: "Plastics Europe", type: "Network", city: "Brussels", country: "BE", lat: 50.85, lon: 4.35, focus: ["Industry Association", "Plastics Manufacturing"], keyInfo: "Represents broader plastics industry. Includes bio-based producers.", iconType: 'network' },
            { name: "SFIF (Swedish Forest Industries Federation)", type: "Network", city: "Stockholm", country: "SE", lat: 59.33, lon: 18.06, focus: ["Industry Association"], keyInfo: "National CEPI member.", iconType: 'network' },
            { name: "SPP (Stowarzyszenie Papierników Polskich)", type: "Network", city: "Warsaw", country: "PL", lat: 52.22, lon: 21.01, focus: ["Industry Association", "Pulp & Paper"], keyInfo: "Polish Pulp and Paper Association. CEPI member.", iconType: 'network' },
            { name: "ZCPP SR (Assoc. Slovak Pulp & Paper Ind.)", type: "Network", city: "Bratislava?", country: "SK", lat: 48.15, lon: 17.11, focus: ["Industry Association"], keyInfo: "National CEPI member.", iconType: 'network' },
        ];

        // --- Data Processing & Merging ---
        // Use a map to store entities for efficient lookup and deduplication
        const combinedEntitiesMap = new Map();
        // Function to generate a unique key for each entity
        const getEntityKey = entity => `${entity.name.toLowerCase().trim()}_${entity.city.toLowerCase().trim()}_${entity.type.toLowerCase().trim()}`;

        entitiesData.forEach(entity => {
            if (entity && entity.name && entity.city && entity.type) {
                 const key = getEntityKey(entity);
                 // Add a unique key property to the entity object itself for later reference
                 entity.uniqueKey = key;
                 combinedEntitiesMap.set(key, entity);
            } else {
                console.warn("Skipping entity due to missing key component:", entity);
            }
        });
        // Final array of unique entities
        const finalEntities = Array.from(combinedEntitiesMap.values());

        // --- Marker and Layer Creation ---
        // Marker cluster group
        const markers = L.markerClusterGroup({
            maxClusterRadius: 55, spiderfyOnMaxZoom: true, showCoverageOnHover: false, zoomToBoundsOnClick: true,
            iconCreateFunction: function(cluster) { // Custom cluster icons
                const count = cluster.getChildCount();
                let size = 'small';
                if (count > 10) size = 'medium';
                if (count > 25) size = 'large';
                const className = `marker-cluster marker-cluster-${size}`;
                return L.divIcon({ html: `<div><span>${count}</span></div>`, className: className, iconSize: L.point(40, 40) });
            }
        });
        // Layer groups for filtering
        const layers = {
            university: L.layerGroup(), institute: L.layerGroup(), company: L.layerGroup(),
            pilot_plant: L.layerGroup(), network: L.layerGroup(), other: L.layerGroup()
        };
        // Object to store marker references, keyed by the entity's uniqueKey
        const markerRefs = {};

        // Function to create the HTML content for the popups
        const createPopupContent = entity => `
            <b class="popup-title">${entity.name}</b>
            <div class="popup-section">
                 <span class="content-text location"><strong>Type:</strong> ${entity.type}</span>
                 <span class="content-text location"><strong>Location:</strong> ${entity.city}, ${entity.country}</span>
            </div>
            ${entity.focus ? `<div class="popup-section">
                 <h4>Focus Areas:</h4>
                 <span class="content-text focus">${Array.isArray(entity.focus) ? entity.focus.join(', ') : entity.focus}</span>
            </div>` : ''}
            ${entity.keyInfo ? `<div class="popup-section">
                 <h4>Key Information / Notes:</h4>
                 <span class="content-text info">${entity.keyInfo}</span>
            </div>` : ''}
            <div class="popup-section">
                 <a href="https://www.google.com/search?q=${encodeURIComponent(entity.name + ' ' + entity.city + ' ' + entity.country)}" target="_blank" rel="noopener noreferrer">Search Online &rarr;</a>
            </div>`;

        // Loop through each entity to create markers and layers
        finalEntities.forEach(entity => {
            if (typeof entity.lat !== 'number' || typeof entity.lon !== 'number' || isNaN(entity.lat) || isNaN(entity.lon)) {
                console.warn("Skipping entity due to invalid or missing coordinates:", entity);
                return;
            }
            const iconType = entity.iconType || 'other';
            const marker = L.marker([entity.lat, entity.lon], {
                icon: icons[iconType] || icons.other,
                alt: entity.name
            })
            .bindPopup(createPopupContent(entity), { maxWidth: 380 })
            .bindTooltip(entity.name);

            // Add hover effect
            marker.on('mouseover', function (e) {
                const element = this.getElement();
                if (element) element.classList.add('marker-hover');
            });
            marker.on('mouseout', function (e) {
                 const element = this.getElement();
                 if (element) element.classList.remove('marker-hover');
            });

            // Add marker to the correct layer group
            const targetLayer = layers[iconType] || layers.other;
            targetLayer.addLayer(marker);

            // Store a reference to the marker using the entity's unique key
            markerRefs[entity.uniqueKey] = marker;

            // Add marker to the cluster group (except for networks)
            if (iconType !== 'network') {
                markers.addLayer(marker);
            } else {
                 marker.addTo(map); // Add networks directly if not clustering
            }
        });

        // Add the marker cluster group to the map
        if (markers.getLayers().length > 0) { markers.addTo(map); }
        // Add individual layers (only if they contain markers and weren't added directly)
        Object.keys(layers).forEach(key => {
            if (key !== 'network' || layers[key].getLayers().length > 0) {
                 layers[key].addTo(map);
            }
        });


        // --- Map Controls ---
        const baseMaps = { "Carto Positron": cartoPositron, "OpenStreetMap": osmTile, "Stamen Toner Lite": stamenTonerLite };
        const overlayMaps = {
            [`<img src="${icons.university.options.iconUrl}" alt="UNI" class="layer-control-icon"><span> Universities (${layers.university.getLayers().length})</span>`]: layers.university,
            [`<img src="${icons.institute.options.iconUrl}" alt="INST" class="layer-control-icon"><span> Institutes/RTOs (${layers.institute.getLayers().length})</span>`]: layers.institute,
            [`<img src="${icons.company.options.iconUrl}" alt="CO" class="layer-control-icon"><span> Companies (${layers.company.getLayers().length})</span>`]: layers.company,
            [`<img src="${icons.pilot_plant.options.iconUrl}" alt="PILOT" class="layer-control-icon"><span> Pilot Plants/Facilities (${layers.pilot_plant.getLayers().length})</span>`]: layers.pilot_plant,
            [`<img src="${icons.network.options.iconUrl}" alt="NET" class="layer-control-icon"><span> Networks/Associations (${layers.network.getLayers().length})</span>`]: layers.network,
            [`<img src="${icons.other.options.iconUrl}" alt="?" class="layer-control-icon"><span> Other (${layers.other.getLayers().length})</span>`]: layers.other
        };
        L.control.layers(baseMaps, overlayMaps, { collapsed: true, position: 'topright' }).addTo(map);
        L.control.scale({ imperial: false }).addTo(map);

        // --- Custom Recenter Control ---
        L.Control.Recenter = L.Control.extend({
            options: { position: 'bottomleft' },
            onAdd: function (map) {
                const btn = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                btn.innerHTML = '&#x21BA;'; btn.title = 'Center Map';
                L.DomEvent.disableClickPropagation(btn);
                btn.onclick = function(e){ L.DomEvent.stop(e); map.setView([50.0, 10.0], 5); };
                return btn;
            }
        });
        new L.Control.Recenter().addTo(map);

        // --- Search Functionality ---
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchMessage = document.getElementById('search-message');

        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            searchMessage.textContent = ''; // Clear previous messages

            if (!query) {
                searchMessage.textContent = 'Please enter a search term.';
                return;
            }

            let foundEntity = null;
            // Find the first entity whose name contains the query (case-insensitive)
            for (const entity of finalEntities) {
                if (entity.name.toLowerCase().includes(query)) {
                    foundEntity = entity;
                    break; // Stop at the first match
                }
            }

            if (foundEntity) {
                const foundMarker = markerRefs[foundEntity.uniqueKey];
                if (foundMarker) {
                    // Function to open popup after zooming/panning
                    const openPopupAfterZoom = () => {
                        foundMarker.openPopup();
                        // Remove the event listener after it fires once
                        map.off('moveend', openPopupAfterZoom);
                        map.off('zoomend', openPopupAfterZoom);
                    };

                    // Check if the marker is in a cluster group
                    const isClustered = markers.hasLayer(foundMarker);

                    if (isClustered) {
                        // If clustered, zoom to reveal the marker first
                        markers.zoomToShowLayer(foundMarker, () => {
                            // Once zoomed, fly to the exact location and open popup
                            map.flyTo(foundMarker.getLatLng(), 15, { // Zoom level 15
                                animate: true,
                                duration: 0.8
                            });
                             // Add listener to open popup *after* flyTo animation finishes
                            map.once('moveend', openPopupAfterZoom);
                            map.once('zoomend', openPopupAfterZoom);
                        });
                    } else {
                        // If not clustered, just fly to the marker
                        map.flyTo(foundMarker.getLatLng(), 15, { // Zoom level 15
                             animate: true,
                             duration: 0.8
                        });
                        // Add listener to open popup *after* flyTo animation finishes
                        map.once('moveend', openPopupAfterZoom);
                        map.once('zoomend', openPopupAfterZoom);
                    }
                     searchMessage.textContent = `Found: ${foundEntity.name}`;
                } else {
                     searchMessage.textContent = 'Marker reference not found for the entity.';
                     console.error("Could not find marker reference for:", foundEntity);
                }
            } else {
                searchMessage.textContent = 'No matching institution found.';
            }
        }

        // Trigger search on button click
        searchButton.addEventListener('click', performSearch);

        // Optional: Trigger search on Enter key press in the input field
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

    </script>
</body>
</html>
